name: Linux Desktop (XFCE + noVNC via ngrok, 6h)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"   # auto-rerun every 6 hours

jobs:
  desktop:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
    - name: Install XFCE, TigerVNC, noVNC
      run: |
        sudo apt-get update
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
          xfce4 xfce4-goodies xfce4-terminal dbus-x11 x11-xserver-utils \
          tigervnc-standalone-server novnc websockify curl unzip

    - name: Configure VNC (password + xstartup)
      env:
        VNC_PASS: "Bee123!!"
      run: |
        mkdir -p ~/.vnc
        # set VNC password (TigerVNC hash format)
        echo -n "${VNC_PASS}" | vncpasswd -f > ~/.vnc/passwd
        chmod 600 ~/.vnc/passwd

        # XFCE session on VNC
        cat > ~/.vnc/xstartup << 'EOF'
        #!/bin/sh
        xrdb $HOME/.Xresources
        startxfce4 &
        EOF
        chmod +x ~/.vnc/xstartup

    - name: Start VNC server (:1)
      run: |
        # kill any stray VNC if present
        vncserver -kill :1 || true
        # start TigerVNC on display :1 (port 5901)
        vncserver :1 -geometry 1366x768 -localhost yes -SecurityTypes VncAuth

        # verify it's listening
        sleep 2
        ss -ltnp | grep 5901 || (echo "VNC not listening on 5901" && exit 1)

    - name: Start noVNC (websocket proxy to VNC)
      run: |
        # noVNC helper script lives here on Ubuntu
        NOVNC=/usr/share/novnc/utils/novnc_proxy
        [ -x "$NOVNC" ] || (echo "noVNC launcher not found at $NOVNC" && exit 1)
        # serve noVNC on :6080 pointing to VNC on :5901
        $NOVNC --vnc localhost:5901 --listen 6080 > novnc.log 2>&1 &
        # verify port 6080 opens
        for i in {1..20}; do (ss -ltn | grep -q ":6080 ") && break || sleep 1; done
        ss -ltn | grep ":6080 " || (echo "noVNC not listening on 6080" && exit 1)

    - name: Download & configure ngrok
      run: |
        curl -fsSL https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-stable-linux-amd64.zip -o ngrok.zip
        unzip -q ngrok.zip
        chmod +x ngrok
        ./ngrok config add-authtoken 30ohlOfgXzLIK3qyF3zX0OWUX9E_2Vz5BaGjNd1XvG1Sn4sUF

    - name: Start ngrok (HTTP tunnel to noVNC) and fetch URL
      run: |
        # Start ngrok in background, log to file in logfmt (v3)
        ./ngrok http 6080 --log=stdout --log-format=logfmt > ngrok.log 2>&1 &
        # wait for URL to appear
        URL=""
        for i in {1..90}; do
          sleep 1
          URL=$(grep -oE 'url=https://[^ ]+' ngrok.log | tail -n1 | sed 's/url=//')
          [ -n "$URL" ] && break
        done
        if [ -z "$URL" ]; then
          echo "âŒ Failed to obtain ngrok URL. Last log lines:" && tail -n 200 ngrok.log
          exit 1
        fi
        echo "===================================="
        echo "âœ… noVNC URL : $URL"
        echo "ðŸ‘¤ VNC user  : (no username)"
        echo "ðŸ”’ VNC pass  : Bee123!!"
        echo "ðŸ“º Display   : :1 (5901)"
        echo "===================================="
        {
          echo "## âœ… Linux Desktop (noVNC)"
          echo "**Open:** $URL"
          echo ""
          echo "**Password:** \`Bee123!!\`"
          echo "_(When the noVNC page loads, it will prompt for the VNC password.)_"
        } >> $GITHUB_STEP_SUMMARY

    - name: Keep alive (6h)
      run: |
        while true; do sleep 30; done

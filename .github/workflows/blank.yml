name: Direct SSH (GitHub Debug)

on:
  workflow_dispatch:

jobs:
  ssh:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6 hours max

    steps:
    - name: Install tmate
      run: |
        sudo apt-get update
        sudo apt-get install -y tmate openssh-client

    - name: Start SSH session
      run: |
        echo "🔹 Starting SSH session..."
        # Start a tmate session
        tmate -F -v -a > tmate.log 2>&1 &

        # Wait for session to start and provide the SSH command
        sleep 5
        cat tmate.log

        echo "========================================="
        echo "💻 Copy the SSH command below to connect:"
        echo ""
        grep -Eo 'ssh .+' tmate.log | head -n 1
        echo ""
        echo "========================================="

        # Keep workflow alive for 6 hours
        sleep 21600
      run: |
        set -eux
        # Start ngrok in background, log to file (v3 syntax compatible)
        ./ngrok tcp 22 --log=stdout --log-format=logfmt > ngrok.log 2>&1 &
        # wait up to 90s for a tcp URL to appear
        URL=""
        for i in $(seq 1 90); do
          sleep 1
          URL=$(grep -oE 'url=tcp://[^ ]+' ngrok.log | tail -n1 | sed 's/url=//')
          [ -n "$URL" ] && break || true
        done
        if [ -z "$URL" ]; then
          echo "❌ Failed to obtain ngrok URL. Last logs:" && tail -n 200 ngrok.log
          exit 1
        fi

        HOST=$(echo "$URL" | sed 's#^tcp://##' | cut -d: -f1)
        PORT=$(echo "$URL" | awk -F: '{print $NF}')

        echo "===================================="
        echo "✅ SSH TUNNEL : $URL"
        echo "👤 Username   : BeeCZ"
        echo "🔒 Password   : Bee123!!"
        echo "🔌 Command    : ssh -p $PORT BeeCZ@$HOST"
        echo "===================================="

        {
          echo "## ✅ Linux SSH"
          echo "**Host:** \`$HOST\`"
          echo "**Port:** \`$PORT\`"
          echo "**User:** \`BeeCZ\`"
          echo "**Pass:** \`Bee123!!\`"
          echo ""
          echo "**Connect:** \`ssh -p $PORT BeeCZ@$HOST\`"
        } >> $GITHUB_STEP_SUMMARY

    - name: Keep alive (6h)
      run: |
        while true; do sleep 30; done

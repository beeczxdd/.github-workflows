name: Linux SSH (ngrok, 6h)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"   # auto-rerun every 6 hours

jobs:
  sshbox:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
    - name: Prep user + OpenSSH
      run: |
        set -eux
        # Create user (idempotent), add to sudo
        sudo useradd -m -s /bin/bash BeeCZ || true
        echo 'BeeCZ:Bee123!!' | sudo chpasswd
        sudo usermod -aG sudo BeeCZ

        # Install ssh server
        sudo apt-get update
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -y openssh-server curl unzip

        # Ensure host keys exist
        sudo ssh-keygen -A

        # Harden + allow password auth for this ephemeral box
        sudo mkdir -p /etc/ssh/sshd_config.d
        cat <<'CONF' | sudo tee /etc/ssh/sshd_config.d/99-actions.conf >/dev/null
PasswordAuthentication yes
ChallengeResponseAuthentication no
UsePAM yes
PermitRootLogin no
AllowUsers BeeCZ
# keep defaults for everything else
CONF

        # Make sure sshd listens on 22
        sudo sed -i 's/^#\?Port .*/Port 22/' /etc/ssh/sshd_config || true

        # Start/restart the service (systemd or sysv)
        (sudo systemctl enable --now ssh) || true
        (sudo systemctl restart ssh) || (sudo service ssh restart) || true

        # Verify itâ€™s actually listening
        sleep 2
        ss -ltnp | grep -E ':22\s' || (echo "âŒ SSH not listening on 22" && exit 1)
        echo "âœ… SSH is up on port 22"

    - name: Download & configure ngrok
      run: |
        set -eux
        curl -fsSL https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-stable-linux-amd64.zip -o ngrok.zip
        unzip -q ngrok.zip
        chmod +x ngrok
        # your token as requested (hardcoded)
        ./ngrok config add-authtoken 30ohlOfgXzLIK3qyF3zX0OWUX9E_2Vz5BaGjNd1XvG1Sn4sUF

    - name: Start ngrok TCP 22 and fetch public address
      run: |
        set -eux
        # Start ngrok in background, log to file (v3 syntax compatible)
        ./ngrok tcp 22 --log=stdout --log-format=logfmt > ngrok.log 2>&1 &
        # wait up to 90s for a tcp URL to appear
        URL=""
        for i in $(seq 1 90); do
          sleep 1
          URL=$(grep -oE 'url=tcp://[^ ]+' ngrok.log | tail -n1 | sed 's/url=//')
          [ -n "$URL" ] && break || true
        done
        if [ -z "$URL" ]; then
          echo "âŒ Failed to obtain ngrok URL. Last logs:" && tail -n 200 ngrok.log
          exit 1
        fi

        HOST=$(echo "$URL" | sed 's#^tcp://##' | cut -d: -f1)
        PORT=$(echo "$URL" | awk -F: '{print $NF}')

        echo "===================================="
        echo "âœ… SSH TUNNEL : $URL"
        echo "ðŸ‘¤ Username   : BeeCZ"
        echo "ðŸ”’ Password   : Bee123!!"
        echo "ðŸ”Œ Command    : ssh -p $PORT BeeCZ@$HOST"
        echo "===================================="

        {
          echo "## âœ… Linux SSH"
          echo "**Host:** \`$HOST\`"
          echo "**Port:** \`$PORT\`"
          echo "**User:** \`BeeCZ\`"
          echo "**Pass:** \`Bee123!!\`"
          echo ""
          echo "**Connect:** \`ssh -p $PORT BeeCZ@$HOST\`"
        } >> $GITHUB_STEP_SUMMARY

    - name: Keep alive (6h)
      run: |
        while true; do sleep 30; done
